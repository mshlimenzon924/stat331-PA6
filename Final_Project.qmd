---
title: "Final Project Linear Regression"
author: "Stolie Erickson, Mira Shlimenzon, Joseph Konat, Casey Avila"
format: 
  html:
    self-contained: true
    code-tools: true
    toc: true
    number-sections: true
editor: source
execute: 
  error: true
  echo: false
  message: false
  warning: false
---

```{r setup}
library(tidyverse)
library(kableExtra)
library(knitr)
library(broom)
library(patchwork)

co2 <- read_csv("co2.csv")
ipp <- read_csv("ipp.csv")

options(scipen = 999)
```

# Data Description

The two variables that we are interested in are the average daily income per capita (independent variable) and how it is related to CO2 emissions per capita (response variable).

### Income Dataset

The income dataset contains information regarding each country's average daily household income based on a 2011 survey. These are measured in constant international dollars (PPP), converting the dollars to amounts that equalize the purchasing power across different currencies/regions. Our data cleaning will reveal more information regarding missing values and numbers that are replacing missing data. On Gapminder, this dataset is titled "Average daily income per capita, PPP (constant 2011 international $)".

### CO2 Dataset

The CO2 data set describes the consumption based CO2 emissions in million tonnes of CO2 per capita. These values are based on the Global Carbon Project 2021. On Gapminder, this dataset is titled "CO2 emissions per capita (Consumption based)".

### Hypothesis

According to some [research](https://www.cgdev.org/media/who-caused-climate-change-historically#:~:text=Developed%20Countries%20Are%20Responsible%20for,Global%20Development%20%7C%20Ideas%20to%20Action), we anticipate that more economically developed countries (those with higher average incomes per capita) will be correlated with higher CO2 emissions compared to countries with lower average incomes per capita.

## Data Cleaning

### CO2 Dataset

Upon initially looking through the CO2 data, we noticed that less economically developed countries in earlier years have repeated emission values for extended periods of time. We believe that it is unreasonable for CO2 emissions per capita to remain exactly the same for 30+ years for several rows. Under the assumption that predictive modeling was used to fill in data which was unknown dating back to 1800, we will be taking steps to clean it. In order to prevent our data from skewing, we are creating a function that will take in each row of the data set, and replace the emission values with NA’s until the emission initially changes. For example, since Australia has an emission value of 0 from 1800 to 1859, then changes in 1860 to .33, our function will sequence through the row and replace all of the 0’s with NA until 1859 (it will keep only the last 0 before the change) then the rest of the row will remain unchanged. Additionally, we noticed how the minus signs of the CO2 emissions per capita were not actual minus signs, so we replaced them accordingly. 

```{r}
clean_init_repeats <- function(df) {
  for (i in 1:nrow(df)) {
    row <- df[i,]
    for (j in 2:(length(row)- 1)) {
      if (row[j] == row[j + 1]) {
        row[j] <- NA
      } else {
        break;
      }
    }
    
    df[i,] <- row
  }
  
  return(df)
}

co2 <- co2 %>%
  clean_init_repeats()

```

### Income Dataset

This dataset suffered from a similar problem to that of the CO2 dataset, so we can
re-use our cleaning function on `ipp`.

```{r}
ipp <- ipp %>%
  clean_init_repeats()
```

## Final Cleanup and Pivoting

### CO2 Dataset

Our CO2 dataset also included negative values, which were encoded as strings due
to them using a "−", rather than "-" (note the slight difference). This was fixed
by replacing the dash with a traditional hyphen so that `as.numeric` could interpret
the string, and then converting the values.

```{r}
co2_long <- co2 %>%
  mutate(across(`1800`:`2020`, 
                ~ as.numeric(str_replace(.x, "−", "-")))) %>%
  pivot_longer(cols = `1800`:`2020`,
               names_to = "year",
               values_to = "emissions")
```

### Income Dataset

This data set included values from the future (2023 - 2050), which were predicted based
off of GDP growth rates for a given country. We removed all values after 2020 in
order to match our CO2 dataset and make joining simpler. We also wanted to avoid any predictive modeling that the income dataset may have used in order to obtain values for years that have not already occurred.

```{r}
ipp_long <- ipp %>%
   select(country:`2020`) %>%
   pivot_longer(cols = `1800`:`2020`,
               names_to = "year",
               values_to = "average_income_per_capita")
```

## Joining the Data

While merging our data, we wanted to ensure that both the explanatory and response variables remained grouped by both the country for which the data was collected and the year. This will ensure that if we want to analyze specific countries then we can group by that aspect, similarly with the year. This will allow us to add details to our visualizations, if desired. 

We decided to drop all of the NA values in the merged data set. This is because with regards to correlation and linear regression, it is generally recommended to remove rows with missing values. When there are missing values in either the predictor or the response variables it can create inconsistencies in the data. This could potentially lead to biased or inaccurate results. Although lm and ggplot automatically drop the NA values, if we plan on doing further summary analysis we want to use the data that is demonstrated in our models.
```{r join}
merged_data <- inner_join(co2_long, ipp_long, by = c("country", "year")) %>%
  drop_na()
```

# Linear Regression

## Data Visualization

#### Income vs. Emissions
```{r}
merged_data %>%
  ggplot(mapping = aes(x = average_income_per_capita, y = emissions)) +
  geom_point(alpha = 0.3, color = "steelblue") +
  labs(x = "Average Income Per Capita (PPP)", y = "",
       title = "Relationship between Average Income and CO2 Emissions Per Capita",
       subtitle = "CO2 Emissions Per Capita (million tonnes)")
```
This graph demonstrates the relationship between average income per capita (x) and CO2 emissions per capita (y). From the graph, we can see that the points appear to follow a positive, somewhat linear correlation. Additionally, we assumed that the negative CO2 emission values could potentially be from countries that actually filter more CO2 out of the atmosphere than they emit, for example tree/vegetation dense areas that are able to remove large emission amounts.

#### Relationship Over Time
```{r}
merged_data %>%
  filter(year %in% c(1920, 1940, 1960, 1980, 2000, 2020)) %>%
  mutate(year = as.factor(year)) %>%
  ggplot(mapping = aes(x = average_income_per_capita, y = emissions)) +
  geom_point(alpha = .3, color = "purple") +
  labs(x = "Average Income per Capita", y = "",
       title = "Relationship between Average Income and CO2 Emissions Per Capita Over Time",
       subtitle = "Emissions per Capita (million tonnes)") +
  facet_wrap(~year)
```


The varying width of intervals on the x-axis for years is a result of missing values. Each country has an x and y value for each year theoretically, but if there are missing values, which are filtered out, then the amount of values to plot decreases for that given year, resulting in slightly different widths on the x-axis.

Furthermore, the relationship between average income per capita vs emissions over time is shown above. There appears to be a positive correlation between income and CO2 emissions. Graphically, we can see that countries with lower average incomes per capita (closer to 0) are lower on the emission scale (blue), whereas the higher emissions are correlated with countries with higher incomes (red/pink). Also, over time, average income per capita has dramatically increased overall. There is a spike in emissions around the 50's through 70's, this could be due to less regulation and the post-war economy.


## Linear Regression Model

For wrangling our data to use for the linear regression model, we decided to summarize our data so we have one x and y value for each country. However, due to the spike in emissions in more recent years, we decided to take the average from 1990 to 2020. We also considered making several intervals of 30 years to increase our data availability, but decided that ultimately pulling data from more recent years in which emissions spiked would be the most insightful. 

```{r}
linear_data <- merged_data %>%
  filter(year %in% c(1990:2020)) %>%
  group_by(country) %>%
  summarize(average_emission = mean(emissions), average_income = mean(average_income_per_capita))
```


```{r}
model <- lm(average_emission ~ average_income, data = linear_data)
summary(model)

linear_data %>%
  ggplot(mapping = aes(x = average_income, y = average_emission)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Average Income (Per Capita)", y = "", subtitle = "Average CO2 Emission (Per Capita)", title = "Linear Regression of Average Income and Average CO2 Per Capita")
```
This graph demonstrates the linear regression for average income per capita (explanatory), and average CO2 emissions per capita (response) from data timing across the years 1990-2020. Each country has an average income and emission value over the entirety of the 30 years, which is the time frame that contains the most recent and reliable numeric values. From the graph, we can see that our line of best fit using the ordinary least squares (OLS) closely follows the data points for the majority of our data 

### Regression Equation 

$$average\_emission = 0.505 + 0.278*average\_income$$
Where $average\_emission$ is the emissions per capita of a country, measured in millions of tonnes of CO2, and $average\_income$ is the average income per capita in constant international dollars.

Interpretation of the Intercept: For countries with an average income per capita of 0 constant international dollars, the estimated CO2 emissions per capita is .505 million tonnes.

Interpretation of $average\_income$: Each increase in one constant international dollar of income per capita is associated with an increase of .278 million tonnes in CO2 emissions per capita for all countries similar to those in the study.

```{r}
response <- var(linear_data$average_emission)
fitted <- var(fitted(model))
residuals <- var(residuals(model))


df <- data.frame(Variance_Type = c("Response Values", "Fitted Values", "Residuals"),
  Variance = c(response, fitted, residuals)) 

df %>%
kable(format = "html", col.names = c('Variance Type', 'Variance')) %>%
column_spec(1, italic = TRUE)  %>%
kable_classic_2(full_width = F, html_font = "Cambria") %>%
add_header_above(font_size = 16, bold = TRUE, c("Variability Information" = 2), background = "lightgray") %>%
row_spec(0, bold = TRUE)

proportion_variability <- 1 - (residuals / response)

proportion_variability
```
The variance (the distribution of a set of data points) of the response values showcases how average_emission varies 45.10085 per capita over time. The variance of the fitted values highlights how much the values predicted by the model are distributed with a variation of 34.15482. The variance of the residuals describes the spread of the difference between the observed values and their corresponding fitted values. This discusses the variability the model doesn't account for which is 10.94603.

75.73% of the variation in average CO2 emissions is explained by the linear regression model, using average income per capita as the predictor variable. This R-squared shows that our model is of reasonable quality, as it shows a good amount of correlation. Ideally we would have an R-squared value even higher (0.9 to 0.95) in order to make precise predictions, but our value of 0.75 is likely enough to establish correlation between average income per capita and CO2 emissions.

#3. Simulation
##3.1 Visualizing Simulations from the Model

# MAKE SURE TO CITE CODE!
```{r}
noise <- function(x, mean = 0, sd){
  x + rnorm(length(x), 
            mean, 
            sd)
}

sim_response <- tibble(sim_average_emissions = noise(predict(model), sd = sigma(model)))
```

```{r}
linear_data
```

```{r}
obs_p <- linear_data %>%
  ggplot(aes(x = average_emission)) +
  geom_histogram() +
  labs(x = "Average Emissions",
       y = "",
       subtitle = "Count") +
  theme_bw()

new_p <- sim_response %>%
  ggplot(aes(x = sim_average_emissions)) +
  geom_histogram() +
  labs(x = "Simulated Average Emissions",
       y = "",
       subtitle = "Count") +
  theme_bw()

obs_p + new_p
```
```{r}
sim_data <- linear_data %>%
  bind_cols(sim_response)
```


```{r}
obs_reg <- sim_data %>%
  ggplot(aes(y = average_emission,
             x = average_income)) +
  geom_point() +
  labs(title = "Average Income vs Average CO2 Emission",
       x = "Average Income (PPP)",
       y = "",
       subtitle = "Average CO2 Emission (million tonnes") +
  theme_bw()

sim_reg <- sim_data %>%
  ggplot(aes(y = sim_average_emissions,
             x = average_income)
         ) +
  geom_point() +
   labs(title = "Average Income vs Simulated C02 Emission",
       x = "Average Income (PPP)",
       y = "",
       subtitle = "Simulated CO2 Emission") +
  theme_bw()

obs_reg + sim_reg
```
From the plots above, we can see that the actual data and simulated data both have positive, linear correlations. However, the actual data appears to have a fan shape, where the points near the origin are clustered very close together, and then as the x-value increases the points spread out. Comparatively, the simulated data clusters upward towards the y-axis from about 5-10 million tonnes of CO2, and is a thicker, more consistent cluster of points as a whole rather than a fan shape. There are several reasons why the points differ. In order to create the simulated CO2 values, R uses our regression equation within our model to predict CO2 emission values based on specific x values. Because it is not realistic for all of these points to lie exactly on the regression line, we added some noise to the points randomly and join the simulated data with our original data set.  


```{r}
sim_data %>% 
  ggplot(aes(x = sim_average_emissions, 
             y = average_emission)
         ) + 
  geom_point() + 
   labs(x = "Simulated Average Emissions", 
        y = "",
        subtitle = "Observed Average Emissions" ) + 
  geom_abline(slope = 1,
              intercept = 0, 
              color = "steelblue",
              linetype = "dashed",
              lwd = 1.5) +
  theme_bw()
```

This graph displays our simulated emissions data against our observed data. The
line at $y = x$ represents an exact match between the two datasets. It is visible that
the two datasets follow the slope of our fitting line. However, this graph also presents
a difference between the two datasets. The simulated dataset has the same amount of noise
regardless of the emission amount, while our observed data has less noise when values are low,
and more when they are high. This is displayed in that low emission values are vertically dense
in the observed data, and horizontally spread out in the simulated data.

```{r}
lm(average_emission ~ sim_average_emissions, 
   data = sim_data
   ) %>% 
  glance() 

sim_r2 <- lm(average_emission ~ sim_average_emissions, 
             data = sim_data
             ) %>% 
  glance() %>% 
  select(r.squared) %>% 
  pull()
sim_r2
```
##3.2 Generating Multiple Predictive Checks
```{r}
nsims <- 1500
sims <- map_dfc(.x = 1:nsims,
                .f = ~ tibble(sim_average_emissions = noise(predict(model), sd = sigma(model))))
```

```{r}
colnames(sims) <- colnames(sims) %>% 
  str_replace(pattern = "\\.\\.\\.",
                  replace = "_")

sims <- linear_data %>% 
  select(average_emission) %>% 
  bind_cols(sims)
```


```{r}
sim_r_sq <- sims %>% 
  map(~ lm(average_emission ~ .x, data = sims)) %>% 
  map(glance) %>% 
  map_dbl(~ .x$r.squared)

head(sim_r_sq)
```

```{r}
sim_r_sq <- sim_r_sq[names(sim_r_sq) != "average_emission"]

tibble(sims = sim_r_sq) %>% 
  ggplot(aes(x = sims)) + 
  geom_histogram(binwidth = 0.025) +
  labs(x = expression("Simulated"~ R^2),
       y = "",
       subtitle = "Number of Simulated Models") +
  theme_bw()
```

### Works Cited

“A Grammar of Animated Graphics.” A Grammar of Animated Graphics •, gganimate.com/. Accessed 7 June 2023. 

“‘Average Daily Income per Capita, PPP (Constant 2011 International $)’,‘CO2 Emissions Per Capita (Consumption Based).’” Gapminder, www.gapminder.org/data/. Accessed 7 June 2023. 

“Developed Countries Are Responsible for 79 Percent of Historical Carbon Emissions.” Center For Global Development | Ideas to Action, www.cgdev.org/media/who-caused-climate-change-historically#:~:text=Developed%20Countries%20Are%20Responsible%20for,Global%20Development%20%7C%20Ideas%20to%20Action. Accessed 7 June 2023. 

“10&nbsp; Predictive Checks.” Stat 331/531 Statistical Computing with R - 10&nbsp; Predictive Checks, earobinson95.github.io/stat331-calpoly-text/10-predictive-checks.html#ch10-checkins. Accessed 7 June 2023. 